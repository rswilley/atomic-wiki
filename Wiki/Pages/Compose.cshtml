@page
@model ComposeModel
@{
    ViewData["Title"] = "Compose";
}

@section Styles {
    <style>
        .btn-group .btn-outline-secondary {
            min-width: 4.5rem;
        }
    </style>
    <link
        rel="stylesheet"
        type="text/css"
        href="https://unpkg.com/tiny-markdown-editor/dist/tiny-mde.min.css"
    />
    <link rel="stylesheet" href="~/lib/tagify/dist/tagify.css">
    <script src="https://unpkg.com/tiny-markdown-editor/dist/tiny-mde.min.js"></script>
}

<h1 class="h4 mb-3">Compose</h1>

<form method="post">
    <div class="row g-3">
        <!-- Left column: main fields -->
        <div class="col-12 col-lg-8">
            <!-- Type selector -->
            <div class="mb-3">
                <label class="form-label small text-muted d-block">Type</label>
                <div class="btn-group btn-group-sm" role="group" aria-label="Entry type">
                    <input type="radio" class="btn-check" name="Type" id="typeNote" value="note"
                           @(Model.Type == "note" ? "checked" : "") onchange="updateComposeVisibility()" />
                    <label class="btn btn-outline-secondary" for="typeNote">Note</label>

                    <input type="radio" class="btn-check" name="Type" id="typePost" value="post"
                           @(Model.Type == "post" ? "checked" : "") onchange="updateComposeVisibility()" />
                    <label class="btn btn-outline-secondary" for="typePost">Post</label>

                    <input type="radio" class="btn-check" name="Type" id="typeJournal" value="journal"
                           @(Model.Type == "journal" ? "checked" : "") onchange="updateComposeVisibility()" />
                    <label class="btn btn-outline-secondary" for="typeJournal">Journal</label>
                </div>
                <span class="text-danger small" asp-validation-for="Type"></span>
            </div>

            <!-- Journal-only date/time (shown via JS) -->
            <div id="journalDateTimeSection" class="row g-2 mb-3 d-none">
                <div class="col-6 col-md-4">
                    <label class="form-label small text-muted">Date</label>
                    <input asp-for="JournalDate" type="date" class="form-control form-control-sm" />
                    <span class="text-danger small" asp-validation-for="JournalDate"></span>
                </div>
            </div>

            <!-- Content -->
            <div class="mb-3">
                <label class="form-label">Content</label>
                <div id="toolbar"></div>
                <textarea asp-for="Markdown" class="form-control" rows="10"></textarea>
                <script type="text/javascript">
                  var tinyMDE = new TinyMDE.Editor({ textarea: "Markdown" });
                </script>
                <span class="text-danger small" asp-validation-for="Markdown"></span>
            </div>
        </div>

        <!-- Right column: metadata -->
        <div class="col-12 col-lg-4">
            <div class="card mb-3">
                <div class="card-body py-3 px-3">
                    <h2 class="h6 mb-2">Details</h2>

                    <!-- Category -->
                    <div class="mb-2">
                        <label class="form-label small text-muted">Category</label>
                        <input asp-for="Category" class="form-control form-control-sm"
                               placeholder="e.g. Development, Visuals, Life..." />
                        <span class="text-danger small" asp-validation-for="Category"></span>
                    </div>

                    <!-- Tags -->
                    <div class="mb-2">
                        <label class="form-label small text-muted">Tags</label>
                        <input asp-for="Tags" class="form-control form-control-sm"
                               placeholder="comma, separated, tags" />
                        <span class="text-danger small" asp-validation-for="Tags"></span>
                        <div class="form-text small">
                            Example: <code>orleans, telemetry, ai</code>
                        </div>
                    </div>

                    <!-- Pinned (notes/posts only; journal usually not) -->
                    <div id="pinnedSection" class="form-check mt-2">
                        <input asp-for="IsPinned" class="form-check-input" />
                        <label class="form-check-label small" asp-for="IsPinned">
                            Pin this entry
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-grid gap-2">
                @if (string.IsNullOrEmpty(Model.PermanentId))
                {
                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                }
                else
                {
                    <button type="submit" class="btn btn-primary btn-sm">Update</button>
                }
                <a asp-page="/Compose"
                   asp-route-type="@Model.Type"
                   asp-route-permanentId="@Model.PermanentId"
                   asp-page-handler="Cancel" class="btn btn-outline-secondary btn-sm">Cancel</a>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <span class="text-danger small" asp-validation-summary="All"></span>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/tagify/dist/tagify.js"></script>
    <script>
        function updateComposeVisibility() {
            var type = document.querySelector('input[name="Type"]:checked')?.value || "note";
            var journalSection = document.getElementById('journalDateTimeSection');
            var pinnedSection = document.getElementById('pinnedSection');

            if (type === "journal") {
                if (journalSection) journalSection.classList.remove('d-none');
                // Journals usually not pinned
                if (pinnedSection) pinnedSection.classList.add('d-none');
            } else {
                if (journalSection) journalSection.classList.add('d-none');
                if (pinnedSection) pinnedSection.classList.remove('d-none');
            }
        }
        
        function tagifyCategory() {
            // Tagify category
            var category = document.querySelector('input[name="Category"]');
            var categoryTagify = new Tagify(category, {
                enforceWhitelist: false,
                mode : "select",
                dropdown: { enabled: 1, maxItems: 8, closeOnSelect: true },
                originalInputValueFormat: valuesArr => valuesArr.map(x => x.value).join(",")
            });

            let abortController;

            categoryTagify.on('input', async function (e) {
                const value = (e.detail.value || "").trim();
                if (value.length < 1) return;

                abortController?.abort();
                abortController = new AbortController();

                const url = `@Url.Page("Compose", null, new { handler = "CategorySuggestions" })&q=${encodeURIComponent(value)}`;
                const res = await fetch(url, { signal: abortController.signal });
                if (!res.ok) return;

                const suggestions = await res.json();
                // Normalize to Tagify's canonical format
                categoryTagify.whitelist = (suggestions || []).map(v => ({ value: v }));
                categoryTagify.dropdown.show(value);
            });
        }

        function tagifyTags() {
            // Tagify tags
            var tags = document.querySelector('input[name="Tags"]');
            var tagsTagify = new Tagify(tags, {
                delimiters: ",",
                dropdown: { enabled: 1, maxItems: 8, closeOnSelect: false },
                originalInputValueFormat: valuesArr => valuesArr.map(x => x.value).join(",")
            });

            let abortController;

            tagsTagify.on('input', async function (e) {
                const value = (e.detail.value || "").trim();
                if (value.length < 1) return;

                abortController?.abort();
                abortController = new AbortController();

                const url = `@Url.Page("Compose", null, new { handler = "TagSuggestions" })&q=${encodeURIComponent(value)}`;
                const res = await fetch(url, { signal: abortController.signal });
                if (!res.ok) return;

                const suggestions = await res.json();
                // Normalize to Tagify's canonical format
                tagsTagify.whitelist = (suggestions || []).map(v => ({ value: v }));
                tagsTagify.dropdown.show(value);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateComposeVisibility();
            tagifyCategory();
            tagifyTags();
        });
    </script>
}
